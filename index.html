<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Maslov </title>
    <style>
        div {
            display: flex;
            justify-content: center;
        }

        div.ok {
            background: green;
        }

        div.fail {
            background: red;
        }

        input {
            padding: 3px;
            margin: 2px;
        }
    </style>
</head>

<body>
    <!-- start with `$ php -S localhost:8000`-->
    <main></main>

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script>
        //** pomoc do sumowania tablic
        Array.prototype.sum = function () {
            return this.reduce(function (previousValue, currentValue, index, array) {
                return previousValue + currentValue;
            });
        }

        let arr = [
            [0],
            [0, 0],
            [0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0, 0]
        ]

        let isWon = false;

        function init() {

            arr.forEach((row, y) => {
                let $div = $('<div></div>');
                $('main').append($div);
                row.forEach((i, x) => {
                    $div.append(
                        `<select data-x="${x}" data-y="${y}">
                            <option>x</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                        </select>`

                        //`<input type="checkbox" maxlength="1" data-x="${x}" data-y="${y}" " pattern="[0-5]{1}"/>`
                    );
                })

            })

            $('select').change(function () {
                let $this = $(this);
                let data = $this.data();
                let val = $this.val();
                switch (val) {
                    case "1":
                    case "2":
                    case "3":
                    case "4":
                    case "5":
                        arr[data.y][data.x] = parseInt(val) == data.y + 1 ? 1 : -1;
                        break;
                    case "x":
                    default:
                    arr[data.y][data.x] = 0;
                }

                loop();
            });
        }

        function loop() {

            let diody = arr.map((value, index, array) => { // sprawdza czy sa wszystkie w rzedzie od gory do dolu

                    let ilosc_zaznaczoncyh = value.filter(i => i != 0).length
                    let ilosc_poprawnych = value.filter(i => i == 1).length;
                    let ilosc_niepoprawnych = value.filter(i => i == -1).length;

                    if (ilosc_niepoprawnych > 0) {
                        return 1;
                    }

                    

                    if (ilosc_zaznaczoncyh == value.length) {
                        if (ilosc_poprawnych == value.length) {
                            return 2; // rzad jest ok
                        }
                        return 1; // nie jest ok
                    }

                    if (ilosc_niepoprawnych == 0 && ilosc_poprawnych > 0) {
                        return 3;// klocek jest polozony w dobrym rzedzie ale trzeba sprawdzic czy porzedni rzad jest ok, bo jak nie to ma czerwono go 
                    }


                    return 0; // nie sa wszystkie polozone klocki 

          
                })
                .reverse() // odwrata tablice
                .map((dioda, index, array) => { // sprawdza czy sa po kolei 
                    if (index == 0) {
                        return dioda
                    }
                    let prevDioda = array[index - 1];
                    if (prevDioda == 2 && dioda == 2) { // jezeli poprzedni rzad  jest 2 i ten jest  2 to ok
                        return 2;
                    }
                    if (prevDioda != 2 && dioda == 3) { // klocek jest polozony w dobrym rzedzie ale trzeba sprawdzic czy porzedni rzad jest ok, bo jak nie to ma czerwono go 
                        return 1;
                    }
                    dioda = dioda == 2 ? 1 : dioda; // jezeli ten jest 2 to zamien na 1
                    return dioda;
                })
                
                .map((dioda, index, array) => { // sprawdza czy sa po kolei                 
                    if (index && dioda > 0 && array[index -1] != 2) {
                        return 1;
                    }
                    if (index && array[index -1] != 2) {
                        return 0;//tylko sprawdzaj jezeli poprzedni rzad jest zielony
                    }
                    return dioda;
                })

            /** jezeil przynajmniej jedna dioda jest na czerwono to te zielone tez na czerwono */
            
            if (diody.indexOf(1) != -1) {
                diody = diody.map(dioda => dioda == 2 ? 1 : dioda);
            }
                

            diody.forEach((dioda, i, array) => { // zaznacz diody 
                let $div = $('div').eq((array.length - 1) - i);                
                $div.removeAttr('class');
                
                switch (dioda) {
                    case 2: // zielony 
                        $div.addClass('ok')
                        break;
                    case 1: // czerowyny
                        $div.addClass('fail')
                        break;
                    case 0: // pusty
                    default:
                }

            })

            let w = diody.sum() == diody.length * 2;

            if (w != isWon) {
                isWon = w;
                if (w) {
                    alert('wygrales');
                }
            }

        }

        init();

        setInterval(loop, 250);
    </script>

</body>